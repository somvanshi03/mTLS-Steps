apiVersion: apps/v1
kind: Deployment
metadata:
  name: curl-test-app
  namespace: flows-pen-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: curl-test-app
  template:
    metadata:
      labels:
        app: curl-test-app
    spec:
      containers:
      - name: curl
        image: curlimages/curl:latest
        command: ["sleep", "3600"]
        env:
        # HAProxy mTLS proxy configuration
        - name: HTTP_PROXY
          value: "http://haproxy-egress:8443"
        - name: HTTPS_PROXY
          value: "http://haproxy-egress:8443"
        - name: NO_PROXY
          value: "localhost,127.0.0.1,.svc.cluster.local"
        
        # Target external domain
        - name: EXTERNAL_DOMAIN
          value: "r1r2.3disystems.com"
        - name: EXTERNAL_URL
          value: "https://r1r2.3disystems.com:443"
        
        # Host header for HAProxy routing
        - name: PROXY_HOST_HEADER
          value: "r1r2.3disystems.com"
        
        # Test commands as environment variables for easy access
        - name: CMD_TEST_PROXY
          value: "curl -vk https://r1r2.3disystems.com"
        - name: CMD_TEST_DIRECT
          value: "curl -vk --noproxy '*' https://r1r2.3disystems.com"
        - name: CMD_TEST_HOST_HEADER
          value: "curl -vk http://haproxy-egress:8443 -H 'Host: r1r2.3disystems.com'"




# Exec into your app pod
kubectl exec -it deploy/your-app -n flows-pen-test -- /bin/sh

# Now run this command inside the pod:
curl -vk https://r1r2.3disystems.com


# Test 1: Via proxy (should work)
curl -vk https://r1r2.3disystems.com

# Test 2: Direct connection (should be blocked by network policy)
curl -vk --noproxy '*' https://r1r2.3disystems.com

# Test 3: Check proxy environment variables
env | grep -i proxy

# Test 4: Verify HAProxy is reachable
curl -v http://haproxy-egress:8443

# Test 5: Using Host header method
curl -vk http://haproxy-egress:8443 -H "Host: r1r2.3disystems.com"
