apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
  namespace: {{ .Release.Namespace }}
data:
  haproxy.cfg: |
    global
      log stdout format raw daemon
      maxconn 4096

    defaults
      log global
      mode http
      timeout connect 10s
      timeout client 60s
      timeout server 60s
      timeout tunnel 3600s
      option httplog
      option dontlognull
      option redispatch
      retries 3

    resolvers dns
      nameserver kube-dns kube-dns.kube-system.svc.cluster.local:53
      hold valid 10s
      accepted_payload_size 8192

    frontend http_front
      bind *:{{ .Values.service.port }}

      # Health check endpoint
      acl is_health_check path /health
      use_backend health_check if is_health_check

{{- range .Values.mtls.domains }}
      # Domain: {{ .name }}
      acl host_{{ .name }} hdr_dom(host) -i {{ .host }}
      use_backend be_{{ .name }} if host_{{ .name }}
{{- end }}

    backend health_check
      mode http
      http-request return status 200 content-type text/plain lf-string "OK\n"

    backend default_backend
      mode http
      http-request return status 503 content-type text/plain lf-string "No backend matched for this domain\n"

{{- range .Values.mtls.domains }}
    backend be_{{ .name }}
      mode http
      server target {{ .host }}:{{ .port }} ssl verify required crt {{ $.Values.mtls.certPath }}/{{ .name }}-client-combined.pem ca-file {{ $.Values.mtls.certPath }}/{{ .name }}-ca-bundle.crt sni str({{ .host }}) alpn h2,http/1.1 resolvers dns resolve-prefer ipv4 check inter 30s fall 3 rise 2
{{- end }}

######

apiVersion: apps/v1
kind: Deployment
metadata:
  name: haproxy-egress
  namespace: {{ .Release.Namespace }}
  labels:
    app: haproxy-egress
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: haproxy-egress
  template:
    metadata:
      labels:
        app: haproxy-egress
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        checksum/secret: {{ include (print $.Template.BasePath "/secrets.yaml") . | sha256sum }}
    spec:
      securityContext:
        fsGroup: 1000
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - haproxy-egress
              topologyKey: kubernetes.io/hostname
      containers:
        - name: haproxy
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          args:
            - "-f"
            - "/usr/local/etc/haproxy/haproxy.cfg"
            - "-db"
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /usr/local/etc/haproxy/haproxy.cfg
              subPath: haproxy.cfg
            - name: mtls
              mountPath: {{ .Values.mtls.certPath }}
              readOnly: true
          readinessProbe:
            httpGet:
              path: /health
              port: {{ .Values.service.port }}
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /health
              port: {{ .Values.service.port }}
            initialDelaySeconds: 10
            periodSeconds: 20
            failureThreshold: 3
          resources:
{{ toYaml .Values.resources | indent 12 }}
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
      volumes:
        - name: config
          configMap:
            name: haproxy-config
        - name: mtls
          secret:
            secretName: {{ .Values.mtls.secretName }}
            defaultMode: 0644
            items:
            {{- range .Values.mtls.domains }}
            - key: {{ .name }}-ca-bundle.crt
              path: {{ .name }}-ca-bundle.crt
            - key: {{ .name }}-client-combined.pem
              path: {{ .name }}-client-combined.pem
            {{- end }}
			
####

apiVersion: apps/v1
kind: Deployment
metadata:
  name: haproxy-egress
  namespace: {{ .Release.Namespace }}
  labels:
    app: haproxy-egress
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: haproxy-egress
  template:
    metadata:
      labels:
        app: haproxy-egress
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        checksum/secret: {{ include (print $.Template.BasePath "/secrets.yaml") . | sha256sum }}
    spec:
      securityContext:
        fsGroup: 1000
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - haproxy-egress
              topologyKey: kubernetes.io/hostname
      containers:
        - name: haproxy
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          args:
            - "-f"
            - "/usr/local/etc/haproxy/haproxy.cfg"
            - "-db"
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /usr/local/etc/haproxy/haproxy.cfg
              subPath: haproxy.cfg
            - name: mtls
              mountPath: {{ .Values.mtls.certPath }}
              readOnly: true
          readinessProbe:
            httpGet:
              path: /health
              port: {{ .Values.service.port }}
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /health
              port: {{ .Values.service.port }}
            initialDelaySeconds: 10
            periodSeconds: 20
            failureThreshold: 3
          resources:
{{ toYaml .Values.resources | indent 12 }}
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
      volumes:
        - name: config
          configMap:
            name: haproxy-config
        - name: mtls
          secret:
            secretName: {{ .Values.mtls.secretName }}
            defaultMode: 0644
            items:
            {{- range .Values.mtls.domains }}
            - key: {{ .name }}-ca-bundle.crt
              path: {{ .name }}-ca-bundle.crt
            - key: {{ .name }}-client-combined.pem
              path: {{ .name }}-client-combined.pem
            {{- end }}
			
####

{{- if .Values.mtls.domains }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.mtls.secretName }}
  namespace: {{ .Release.Namespace }}
type: Opaque
stringData:
{{- range .Values.mtls.domains }}
  {{ .name }}-ca-bundle.crt: |-
{{ .caBundlePem | b64dec | b64dec | indent 4 }}
  {{ .name }}-client-combined.pem: |-
{{ .clientCombinedPem | indent 4 }}
{{- end }}
{{- end }}

#####

apiVersion: v1
kind: Service
metadata:
  name: haproxy-egress
  namespace: {{ .Release.Namespace }}
spec:
  type: {{ .Values.service.type }}
  selector:
    app: haproxy-egress
  ports:
    - port: {{ .Values.service.port }}
      targetPort: {{ .Values.service.port }}
      protocol: TCP
      name: http
	  
####

apiVersion: v1
kind: Pod
metadata:
  name: curl-test
  namespace: flows-pen-test
  labels:
    app: curl-test
    purpose: mTLS-testing
spec:
  containers:
  - name: curl
    image: curlimages/curl
    command: ["sleep", "3600"]
    env:
    # Direct connection variables (will be blocked by network policy)
    - name: DIRECT_URL
      value: "https://r1r2.3disystems.com:443"
    - name: DIRECT_DOMAIN
      value: "r1r2.3disystems.com"
    - name: DIRECT_PORT
      value: "443"
    
    # HAProxy connection variables (working mTLS path)
    - name: HAPROXY_URL
      value: "http://haproxy-egress:8443"
    - name: HAPROXY_SVC
      value: "haproxy-egress"
    - name: HAPROXY_PORT
      value: "8443"
    - name: HOST_HEADER
      value: "r1r2.3disystems.com"
    
    # Test commands as variables
    - name: CMD_DIRECT
      value: "curl -vk https://r1r2.3disystems.com:443"
    - name: CMD_DIRECT_TIMEOUT
      value: "curl -vk --connect-timeout 5 https://r1r2.3disystems.com:443"
    - name: CMD_VIA_HAPROXY
      value: "curl -v http://haproxy-egress:8443 -H 'Host: r1r2.3disystems.com'"
    - name: CMD_HAPROXY_HEALTH
      value: "curl -v http://haproxy-egress:8443/health -H 'Host: r1r2.3disystems.com'"
    
    # DNS and network test variables
    - name: DNS_SERVER
      value: "8.8.8.8"
    - name: TEST_ENDPOINT
      value: "r1r2.3disystems.com"
    - name: EXPECTED_IP
      value: "13.91.0.38"
    
    # Curl options
    - name: CURL_OPTS
      value: "-v --connect-timeout 5"
    - name: CURL_OPTS_INSECURE
      value: "-vk --connect-timeout 5"
	  
#####

apiVersion: v2
name: haproxy-egress
description: HAProxy mTLS egress proxy
type: application
version: 0.1.0
appVersion: "2.9"

####

replicaCount: 1

image:
  repository: haproxy
  tag: "2.9"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 8443

resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 50m
    memory: 64Mi

mtls:
  certPath: /etc/mtls
  secretName: haproxy-mtls-secret
  domains: []           # Will be overridden

networkPolicy:
  enabled: true
  externalCidrs: []
  internalCidrs: []     # Will be overridden
  
  
###

replicaCount: 1

image:
  repository: haproxy
  tag: "2.9"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 8443

resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 50m
    memory: 64Mi

mtls:
  certPath: /etc/mtls
  secretName: haproxy-mtls-secret
  domains: []           # Will be overridden

networkPolicy:
  enabled: true
  externalCidrs: []
  internalCidrs: []     # Will be overridden
  
####

helmDefaults:
  timeout: 1500
  wait: true
  kubeContext: aks-scp-prd-uks-st-pen

releases:
  - name: haproxy-egress
    namespace: flows-pen-test
    chart: ../../../templated-overrides/raw-yaml-charts/mtls-outbound
    values:
      - namespace.overrides.gotmpl
