apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
  namespace: {{ .Release.Namespace }}
data:
  haproxy.cfg: |
    global
      log stdout format raw daemon
      maxconn 4096

    defaults
      log global
      mode http
      timeout connect 10s
      timeout client 60s
      timeout server 60s
      timeout tunnel 3600s
      option httplog
      option dontlognull
      option redispatch
      retries 3

    resolvers dns
      nameserver kube-dns kube-dns.kube-system.svc.cluster.local:53
      hold valid 10s
      accepted_payload_size 8192

    frontend http_front
      bind *:{{ .Values.service.port }}

      # Health check endpoint
      acl is_health_check path /health
      use_backend health_check if is_health_check

{{- range .Values.mtls.domains }}
      # Domain: {{ .name }}
      acl host_{{ .name }} hdr_dom(host) -i {{ .host }}
      use_backend be_{{ .name }} if host_{{ .name }}
{{- end }}

    backend health_check
      mode http
      http-request return status 200 content-type text/plain lf-string "OK\n"

    backend default_backend
      mode http
      http-request return status 503 content-type text/plain lf-string "No backend matched for this domain\n"

{{- range .Values.mtls.domains }}
    backend be_{{ .name }}
      mode http
      server target {{ .host }}:{{ .port }} ssl verify required crt {{ $.Values.mtls.certPath }}/{{ .name }}-client-combined.pem ca-file {{ $.Values.mtls.certPath }}/{{ .name }}-ca-bundle.crt sni str({{ .host }}) alpn h2,http/1.1 resolvers dns resolve-prefer ipv4 check inter 30s fall 3 rise 2
{{- end }}
